---
title: Auth API
description: Documentation de l'API d'authentification XetaSuite.
---

import { Aside } from '@astrojs/starlight/components';

XetaSuite utilise **Laravel Sanctum** en mode stateful (cookies) pour l'authentification SPA.

## Endpoints d'authentification

### Obtenir le cookie CSRF

<Aside type="caution">
  Cet endpoint doit être appelé **avant** login et logout.
</Aside>

```http
GET /sanctum/csrf-cookie
```

**Réponse :** Cookie `XSRF-TOKEN` défini

---

### Login

```http
POST /api/v1/auth/login
```

**Headers :**
```
Content-Type: application/json
Accept: application/json
X-XSRF-TOKEN: {token from cookie}
```

**Body :**
```json
{
    "email": "user@example.com",
    "password": "password",
    "remember": true
}
```

**Réponse 200 :**
```json
{
    "two_factor": false
}
```

**Réponse 422 (Validation) :**
```json
{
    "message": "The provided credentials are incorrect.",
    "errors": {
        "email": ["The provided credentials are incorrect."]
    }
}
```

---

### Two-Factor Challenge

Si `two_factor: true` dans la réponse login :

```http
POST /api/v1/auth/two-factor-challenge
```

**Body :**
```json
{
    "code": "123456"
}
```

Ou avec un code de récupération :
```json
{
    "recovery_code": "abcd-efgh-ijkl"
}
```

---

### Logout

```http
POST /api/v1/auth/logout
```

**Réponse 204 :** No Content

---

### Utilisateur courant

```http
GET /api/v1/user
```

**Réponse :**
```json
{
    "data": {
        "id": 1,
        "first_name": "Jean",
        "last_name": "Dupont",
        "full_name": "Jean Dupont",
        "email": "jean@example.com",
        "username": "jdupont",
        "locale": "fr",
        "current_site_id": 1,
        "roles": ["admin"],
        "permissions": ["company.viewAny", "company.view", "..."],
        "sites": [
            {
                "id": 1,
                "name": "Siège",
                "is_headquarters": true
            }
        ]
    }
}
```

---

### Changer de site

```http
PATCH /api/v1/user/site
```

**Body :**
```json
{
    "site_id": 2
}
```

**Réponse :** Utilisateur mis à jour avec les nouvelles permissions pour le site sélectionné.

---

### Changer la langue

```http
PATCH /api/v1/user/locale
```

**Body :**
```json
{
    "locale": "en"
}
```

## Implémentation client React

```typescript
// httpClient.ts
const httpClient = axios.create({
    baseURL: import.meta.env.VITE_API_URL || '',
    headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
    },
    withCredentials: true,   // Requis pour les cookies Sanctum
    withXSRFToken: true,     // Inclut automatiquement le header XSRF-TOKEN
});

// AuthRepository.ts
export const AuthRepository = {
    login: async (credentials: LoginCredentials): Promise<void> => {
        await httpClient.get('/sanctum/csrf-cookie');
        await httpClient.post('/api/v1/auth/login', credentials);
    },
    logout: async (): Promise<void> => {
        await httpClient.get('/sanctum/csrf-cookie');
        await httpClient.post('/api/v1/auth/logout');
    },
};
```
