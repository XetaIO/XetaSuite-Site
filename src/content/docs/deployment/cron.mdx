---
title: Cron & Scheduler
description: Configuration du scheduler Laravel pour les tâches planifiées.
---

import { Tabs, TabItem, Aside } from '@astrojs/starlight/components';

Laravel Scheduler permet de définir des tâches planifiées dans le code plutôt que dans le crontab.

## Configuration du Cron

Ajoutez une seule entrée cron pour exécuter le scheduler Laravel :

```bash
* * * * * cd /var/www/xetasuite-core && php artisan schedule:run >> /dev/null 2>&1
```

<Tabs>
  <TabItem label="Linux">
    ```bash
    crontab -e
    ```
    Ajoutez la ligne ci-dessus.
  </TabItem>
  <TabItem label="Laravel Forge">
    1. Aller dans **Servers** → votre serveur
    2. Cliquez sur **Scheduler**
    3. Cochez **Enable Scheduler** pour le site
  </TabItem>
</Tabs>

## Tâches planifiées de XetaSuite

Les tâches sont définies dans `routes/console.php` :

```php
use Illuminate\Support\Facades\Schedule;

// Nettoyage des sessions expirées
Schedule::command('session:gc')->daily();

// Purge des jobs en échec anciens
Schedule::command('queue:prune-failed --hours=48')->daily();

// Backup quotidien
Schedule::command('backup:run')->dailyAt('02:00');

// Nettoyage des anciens backups
Schedule::command('backup:clean')->dailyAt('03:00');
```

## Commandes utiles

### Voir les tâches planifiées

```bash
php artisan schedule:list
```

### Exécuter manuellement le scheduler

```bash
php artisan schedule:run
```

### Exécuter une commande spécifique

```bash
php artisan backup:run
```

## Backups

<Aside type="note">
  XetaSuite utilise `spatie/laravel-backup` pour les sauvegardes automatiques.
</Aside>

### Configuration

Éditez `config/backup.php` :

```php
'backup' => [
    'name' => env('APP_NAME', 'xetasuite'),
    'source' => [
        'files' => [
            'include' => [base_path()],
            'exclude' => [
                base_path('vendor'),
                base_path('node_modules'),
            ],
        ],
        'databases' => ['pgsql'],
    ],
    'destination' => [
        'disks' => ['s3'],  // ou 'local'
    ],
],
```

### Commandes disponibles

```bash
# Exécuter le backup
php artisan backup:run

# Exécuter le backup (base de données uniquement)
php artisan backup:run --only-db

# Lister les backups
php artisan backup:list

# Nettoyer les anciens backups
php artisan backup:clean
```

## Monitoring

### Vérifier que le scheduler fonctionne

```bash
php artisan schedule:list
```

### Voir les logs

```bash
tail -f storage/logs/laravel.log
```

### Jobs en échec

```bash
php artisan queue:failed
```
