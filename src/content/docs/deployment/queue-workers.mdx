---
title: Queue Workers
description: Configuration des workers de queue pour XetaSuite.
---

import { Tabs, TabItem, Aside } from '@astrojs/starlight/components';

XetaSuite utilise les queues Laravel pour les tâches asynchrones : envoi d'emails, génération de rapports, etc.

## Configuration

### Driver recommandé : Redis

```bash
QUEUE_CONNECTION=redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
```

### Alternative : Database

```bash
QUEUE_CONNECTION=database
```

Créer la table de jobs :
```bash
php artisan queue:table
php artisan migrate
```

## Lancer un worker

### Développement

```bash
php artisan queue:work
```

### Production

Utilisez un process manager pour maintenir les workers actifs.

<Tabs>
  <TabItem label="Supervisor">
    Créez `/etc/supervisor/conf.d/xetasuite-worker.conf` :

    ```ini
    [program:xetasuite-worker]
    process_name=%(program_name)s_%(process_num)02d
    command=php /var/www/xetasuite-core/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
    autostart=true
    autorestart=true
    stopasgroup=true
    killasgroup=true
    user=www-data
    numprocs=2
    redirect_stderr=true
    stdout_logfile=/var/www/xetasuite-core/storage/logs/worker.log
    stopwaitsecs=3600
    ```

    Activer :
    ```bash
    sudo supervisorctl reread
    sudo supervisorctl update
    sudo supervisorctl start xetasuite-worker:*
    ```
  </TabItem>
  <TabItem label="Systemd">
    Créez `/etc/systemd/system/xetasuite-worker.service` :

    ```ini
    [Unit]
    Description=XetaSuite Queue Worker
    After=network.target

    [Service]
    User=www-data
    Group=www-data
    Restart=always
    ExecStart=/usr/bin/php /var/www/xetasuite-core/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
    StandardOutput=append:/var/www/xetasuite-core/storage/logs/worker.log
    StandardError=append:/var/www/xetasuite-core/storage/logs/worker-error.log

    [Install]
    WantedBy=multi-user.target
    ```

    Activer :
    ```bash
    sudo systemctl enable xetasuite-worker
    sudo systemctl start xetasuite-worker
    ```
  </TabItem>
  <TabItem label="Laravel Forge">
    1. Aller dans **Servers** → votre serveur
    2. Cliquez sur **Queue** dans le menu
    3. Configurer :
       - **Connection** : `redis`
       - **Queue** : `default`
       - **Processes** : `2`
    4. Cliquez sur **Create Worker**
  </TabItem>
</Tabs>

## Commandes utiles

### Surveiller les workers

```bash
php artisan queue:monitor redis:default
```

### Voir les jobs en échec

```bash
php artisan queue:failed
```

### Retenter les jobs en échec

```bash
# Retenter tous
php artisan queue:retry all

# Retenter un spécifique
php artisan queue:retry 5
```

### Purger les jobs en échec

```bash
php artisan queue:flush
```

## Redémarrer après déploiement

<Aside type="caution">
  Les workers doivent être redémarrés après le déploiement pour charger les nouvelles modifications.
</Aside>

```bash
php artisan queue:restart
```

Cette commande signale aux workers de redémarrer gracieusement après avoir terminé leur job en cours.

## Horizon (Optionnel)

Pour une gestion plus avancée des queues, envisagez d'utiliser [Laravel Horizon](https://laravel.com/docs/horizon) :

```bash
composer require laravel/horizon
php artisan horizon:install
php artisan migrate
```

Lancer Horizon :
```bash
php artisan horizon
```

Accédez au dashboard à `/horizon`.
