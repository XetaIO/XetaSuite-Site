---
title: Multi-Sites & Zones
description: Architecture multi-tenant avec gestion des sites et zones imbriquées.
---

import { Aside } from '@astrojs/starlight/components';

XetaSuite est conçu pour gérer **plusieurs sites** (multi-tenant), chacun avec ses propres zones, équipements et permissions.

## Hiérarchie des entités

```
Organisation
└── Sites
    ├── Siège (is_headquarters = true)
    │   └── Gère les Companies globalement
    │
    └── Sites réguliers
        └── Zones (imbriquées)
            └── Matériels
                ├── Maintenances
                ├── Incidents
                └── Nettoyages
```

## Site Siège (Headquarters)

<Aside type="note">
  Le **Site Siège** (`is_headquarters = true`) est un site spécial qui gère les ressources globales comme les Companies (fournisseurs).
</Aside>

### Ressources HQ-Only

| Ressource | Description |
|-----------|-------------|
| Companies | Fournisseurs de pièces et/ou maintenanciers |

### Protection dans les Policies

```php
class CompanyPolicy
{
    public function before(User $user, string $ability): ?bool
    {
        // Bloque l'accès si l'utilisateur n'est pas sur le siège
        if (! isOnHeadquarters()) {
            return false;
        }
        return null; // Continue vers la vérification de permission
    }
}
```

## Changement de site

Les utilisateurs peuvent changer de site via le **SiteSwitcher** :

```typescript
// Frontend - SiteSwitcher.tsx
const handleSiteChange = async (site: UserSite) => {
    await switchSite(site.id);  // PATCH /api/v1/user/site
    window.location.reload();   // Recharge les permissions
};
```

<Aside type="caution">
  Un **rechargement de page** est nécessaire après le changement de site pour rafraîchir les permissions dans le contexte React.
</Aside>

## Structure de données User

```typescript
interface User {
    id: number;
    current_site_id?: number;
    roles: string[];        // Rôles du site actuel
    permissions: string[];  // Permissions du site actuel
    sites: UserSite[];      // Tous les sites accessibles
}

interface UserSite {
    id: number;
    name: string;
    is_headquarters: boolean;
}
```

## Prochaines étapes

- [Gestion Utilisateurs](/admin/users/) - Créer et gérer les utilisateurs
- [Gestion des Rôles](/admin/roles/) - Configurer les rôles par site
